<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>質問トリガー</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #f5f5f5;
        }
        .status {
            text-align: center;
            padding: 2rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        .status.success { border-left: 4px solid #27ae60; }
        .status.error { border-left: 4px solid #e74c3c; }
        .status.processing { border-left: 4px solid #3498db; }
        .status h2 { margin: 0 0 0.5rem; font-size: 1.2rem; }
        .status p { margin: 0; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="status processing" id="status">
        <h2>処理中...</h2>
        <p>質問を切り替えています</p>
    </div>

    <script>
        (async () => {
            const statusEl = document.getElementById('status');

            function showResult(type, title, message) {
                statusEl.className = 'status ' + type;
                statusEl.innerHTML = '<h2>' + title + '</h2><p>' + message + '</p>';
            }

            try {
                const params = new URLSearchParams(window.location.search);
                const eventId = parseInt(params.get('event'));
                const qNumber = parseInt(params.get('q'));

                if (!eventId || isNaN(qNumber)) {
                    showResult('error', 'パラメータエラー', 'event と q パラメータが必要です');
                    return;
                }

                // q=0: プレゼン終了
                if (qNumber === 0) {
                    const { data: existing } = await supabaseClient
                        .from('admin_state')
                        .select('id')
                        .eq('event_id', eventId)
                        .maybeSingle();

                    if (existing) {
                        await supabaseClient
                            .from('admin_state')
                            .update({
                                current_question_id: null,
                                is_presenting: false,
                                updated_at: new Date().toISOString()
                            })
                            .eq('event_id', eventId);
                    }

                    showResult('success', 'プレゼン終了', '待機画面に戻しました');
                    return;
                }

                // 質問一覧を取得（sort_order順）
                const { data: questions, error: qError } = await supabaseClient
                    .from('questions')
                    .select('id, question_text')
                    .eq('event_id', eventId)
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true });

                if (qError) throw qError;

                if (!questions || questions.length === 0) {
                    showResult('error', 'エラー', '質問が見つかりません');
                    return;
                }

                if (qNumber < 1 || qNumber > questions.length) {
                    showResult('error', '範囲外', 'q=' + qNumber + ' は無効です（1〜' + questions.length + '）');
                    return;
                }

                const targetQuestion = questions[qNumber - 1];

                // admin_state を upsert
                const { data: existing } = await supabaseClient
                    .from('admin_state')
                    .select('id')
                    .eq('event_id', eventId)
                    .maybeSingle();

                const stateData = {
                    current_question_id: targetQuestion.id,
                    is_presenting: true,
                    updated_at: new Date().toISOString()
                };

                if (existing) {
                    const { error } = await supabaseClient
                        .from('admin_state')
                        .update(stateData)
                        .eq('event_id', eventId);
                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('admin_state')
                        .insert([{ event_id: eventId, ...stateData }]);
                    if (error) throw error;
                }

                showResult('success',
                    'Q' + qNumber + ' を表示',
                    targetQuestion.question_text);

            } catch (err) {
                console.error(err);
                showResult('error', 'エラー', err.message);
            }
        })();
    </script>
</body>
</html>
