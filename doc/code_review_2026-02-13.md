# コードレビューレポート

**レビュー日**: 2026-02-13
**レビュー対象**: Enquete-system 全体
**レビュー者**: Claude Code

---

## 総合評価: ⭐⭐⭐⭐ (4/5) - 本番運用に適した品質

---

## 良い点

### 1. セキュリティ
- **XSS対策**: `escapeHtml()` 関数が両ファイル(admin.js:1289, app.js:897)に実装され、ユーザー入力の出力時に適切にエスケープ
- **SQLインジェクション防止**: Supabase SDK のパラメータ化クエリを使用
- **レート制限**: 投稿スパム防止 (3回/分) を実装 (app.js:341-360)
- **AIモデレーション**: OpenAI Moderation API による自動コンテンツフィルタリング (Edge Function)

### 2. エラーハンドリング
- **フォールバック設計**: モデレーションカラムが存在しない場合の再試行ロジック (app.js:747-780)
- **fail-open パターン**: レート制限やモデレーションAPI失敗時もユーザー操作を妨げない
- **try-catch**: 主要な非同期処理に適切に配置

### 3. UX/信頼性
- **ハートビート機構**: 管理者セッション監視 (admin.js:1627-1644)
- **鮮度チェック**: 参加者側で90秒タイムアウト検知 (app.js:192-212)
- **beforeunload + keepalive**: ブラウザ閉じても状態クリーンアップ (admin.js:1646-1668)
- **visibilitychange**: スリープ復帰対応 (app.js:51-57)

### 4. コード構造
- **関数分離**: 機能ごとに適切に分割
- **命名規則**: 日本語コメント付きで可読性が高い
- **状態管理**: グローバル変数の役割が明確

---

## 改善提案

### 高優先度

#### 1. 認証なし（セキュリティ上の最重要課題）
**現状**: admin.html は URL を知っている誰でもアクセス可能
**リスク**: 誰でもイベント削除、質問変更、回答削除が可能
**対策**: `doc/auth_login_plan.md` に計画済み。Phase 1 で Supabase Auth 導入予定

#### 2. RLS ポリシーが全開放
**現状**: `USING (true)` で全テーブルが誰でも読み書き可能
**リスク**: 悪意のあるユーザーが他イベントのデータを操作可能
**対策**: 認証導入後、`owner_id` ベースのポリシーに更新予定

### 中優先度

#### 3. innerHTML 使用箇所
**箇所**: admin.js:107 `document.getElementById('admin-policy-body').innerHTML = bodyHTML;`
**リスク**: 内部で生成した HTML だが、将来の変更でXSS脆弱性になる可能性
**対策**: 可能であれば DOM API で構築、または入力検証を強化

#### 4. セッションID の予測可能性
**現状**: `session_` + タイムスタンプ + 短いランダム文字列 (config.js:12)
```javascript
sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
```
**リスク**: 同時刻に生成されたIDが衝突する可能性（低確率）
**対策**: `crypto.randomUUID()` の使用を検討（モダンブラウザでサポート）

#### 5. Edge Function の型安全性
**箇所**: moderate-content/index.ts:66
```typescript
let moderationInput: any
```
**対策**: 適切な型定義を追加

### 低優先度

#### 6. コンソールログの残存
**箇所**: 多数の `console.log` / `console.warn` / `console.error`
**対策**: 本番ビルド時に削除、または環境変数でログレベル制御

#### 7. マジックナンバー
**例**:
- `30000` (ハートビート間隔)
- `90000` (タイムアウト)
- `800` (画像リサイズ)

**対策**: 定数として先頭で定義（一部は実施済み）

---

## パフォーマンス

| 項目 | 状態 | コメント |
|------|------|----------|
| 画像リサイズ | ✅ | クライアント側 Canvas API で処理 |
| Realtime | ✅ | 必要なテーブルのみ購読 |
| DB クエリ | ✅ | インデックス活用、必要カラムのみ SELECT |
| バンドルサイズ | ⚠️ | ビルドツール未使用で minify なし（許容範囲） |

---

## ファイル別サマリー

| ファイル | 行数 | 品質 | 主な役割 |
|----------|------|------|----------|
| admin.js | 1669 | ⭐⭐⭐⭐ | 管理画面全機能（イベント/質問/結果/プレゼン） |
| app.js | 907 | ⭐⭐⭐⭐ | 参加者回答（画像リサイズ、レート制限、ポリシー同意） |
| config.js | 19 | ⭐⭐⭐⭐ | Supabase 接続、セッション管理 |
| moderate-content/index.ts | 174 | ⭐⭐⭐⭐ | AI モデレーション（fail-open 設計） |

---

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────┐
│  GitHub Pages (Static Site)                             │
│  ├── index.html (参加者)                                │
│  ├── admin.html (管理者)                                │
│  ├── trigger.html (PowerPoint連携)                      │
│  ├── app.js / admin.js / config.js                      │
│  └── style.css                                          │
└─────────────────────────────────────────────────────────┘
         ↓ REST/WebSocket
┌─────────────────────────────────────────────────────────┐
│  Supabase Backend                                       │
│  ├── PostgreSQL (events, questions, responses等)        │
│  ├── Realtime (WebSocket)                               │
│  ├── Storage (survey-images バケット)                   │
│  └── Edge Functions (moderate-content)                  │
└─────────────────────────────────────────────────────────┘
         ↓ API
┌─────────────────────────────────────────────────────────┐
│  External APIs                                          │
│  └── OpenAI Moderation API                              │
└─────────────────────────────────────────────────────────┘
```

---

## 結論

- **本番利用可能**: 現状でも教育・セミナー用途として十分機能する
- **最優先課題**: 認証機能の追加（計画済み）
- **コード品質**: 適切なエラーハンドリング、XSS対策、UX考慮がなされている
- **拡張性**: 関数分離が適切で、認証追加時の影響範囲が明確

---

## 次のアクション

1. **Phase 1 実装**: Supabase Auth によるログイン保護 (`doc/auth_login_plan.md` 参照)
2. **RLS 強化**: 認証導入後、`owner_id` ベースのポリシーに更新
3. **セッションID改善**: `crypto.randomUUID()` への移行検討
